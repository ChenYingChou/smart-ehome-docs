通訊轉接模組功能
---

### 功能概述
* 每一通訊轉接模組可能接１到數個設備，請自行定義通訊協定所需的設備及各功能 ID (文數字組合)。
* 本模組負責轉換本地設備和伺服器的通訊協定：
    1. 定義通訊協定設備及功能 ID 和內部指令的對照轉換。
    2. 當從設備功能收到異動狀態值時，轉換成通訊協定 JSON 格式，送往伺服器 (Public Queue)。
    3. 當從伺服器 (Private Queue) 收到 JSON 命令時，依指定命令將 Value 送往本地的設備。
* 第一次以 RPC 方式向管理系統註冊 (設備/功能/類型/值域/說明/UI 元件)，並取得模組 ID (相當於 Private Queue ID) 及 auth-token (身份驗證令牌)。
* 當設備取得最新狀態時，若未變更則不需送往伺服器。除非該設備需定時記錄繪製統計圖表 (如温度、濕度、PM2.5)。

### 預估模組
* RS232/485 模組。
* ModBus 模組。
* Amma TCP/485 模組。

### 銨茂通訊模組

![](../../img/AMMA%20模組關聯圖.svg)

#### 模組事件

以下事件供額外監測使用，本系統各模組已自行關聯必要的事件處理

1. AmAdaptor
    * `publish(string|string[])`: devices 模組監測用，將 "`|<did>|<fid>|status`" 加上前置 "`<sid>|<mid>`" 後再送往系統 MQ。
    * `_write(Buffer)`: AmTcp 或 Am485 模組監測用，將指定 `Buffer` 送往實體設備。
    * `error(Error)`: 發生錯誤原因。
    * `packet(Buffer)`: 收到實體設備送來分析過的完整封包。
    * `device(id: string, type: string)`: AmAdaptor.queryDevice() 中使用，收到設備識別查詢回覆。
    * `qfull(Buffer)`: `write(Buffer)` 未能立即輸出時，且緩衝暫存區已達到指定最大數量 `opts.maxQueues`。
    * `qempty()`: 輸出緩衝區已清空。

2. AmTcp 或 Am485
    * `connect(...)`: 連線成功。
    * `error(Error)`: 發生錯誤原因，根據 `opts.reconnect` 決定是否再次執行連線。
    * `close(hasError: boolean)`: 連線結束，根據 `opts.reconnect` 決定是否再次執行連線。
    * `timeout()`: tcp 逾時無回應，根據 `opts.reconnect` 決定是否再次執行連線。
    * `blocked()`: 設備輸出時是否系統緩衝空間已滿。
    * `drain()`: 設備輸出緩衝已清空，僅曾發生 `blocked` 事件後才會有。
    * `read(Buffer)`: 設備發生讀取事件。
    * `write(Buffer)`: 設備發生輸出事件。

