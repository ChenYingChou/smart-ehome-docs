通訊轉接模組 ↔ 本地伺服器
---

1. 標準 json 格式: Cmd, {Server,} {Module,} Device, Function, Value, {Auth-Token}<br>範例: 設定空調温度為 26 度。(由 Server 發向通訊轉接模組)
    ```js
    {
        "cmd": 1,
        "m_id": "Module ID",
        "d_id": "Conditioner",
        "f_id": "Temperature",
        "value": 26,
        "token": "註冊時所給予的身份驗證令牌"        // 回報狀態時(Module → Server)要帶身份驗證令牌
    }
    ```

2. 第一次向管理系統註冊:
    * REST API: POST "http://local-server/api"

    * MQTT: mqtt://local-server
        * 送出 topic = "public"
        * 接收 topic = "reply"

    * 送出本模組所擁有的 "設備/功能/類型/情境/UI 元件":
        ```js
        {
            "cmd": 99,
            "m_id": "**My-ID**",    // 自定模組ID
            "name": "**模組名稱**",  // 自定模組名稱
            "devices": [            // 設備陣列
                {   // 第一個設備
                    "d_id": "**Device1**",      // 自定設備ID
                    "name": "**設備名稱**",      // 自定設備名稱
                    "functions": [              // 功能陣列
                        {   // 第一個功能
                            "f_id": "**DI-1**",     // 自定功能ID
                            "name": "**功能名稱**",  // 自定功能名稱
                            "type": 1,              // 輸入(狀態):1, 輸出(控制):2, 輸出入:3
                            "value": "__Value__",   // 1, 2, 3, 100/n, n1~n2
                            "ui": "__UI__"          // UI 元件
                        },
                        // 第 2,3,... 功能
                    ]
                },
                // 第 2,3,... 設備
            ],
            "key": "**16 個隨機字元轉十六進位字串, 共 32 HEX 字元**"
        }
        ```

        functions 中的欄位說明:
        * type:

            |  值  |    說明    |
            |:----:|:---------:|
            |   1  | 可讀取狀態  |
            |   2  | 可輸出控制  |
            |   3  | 可讀取/輸出 |

        * value:

            |   值  |    說明                                |
            |:-----:|:-------------------------------------:|
            |   1   | 一次觸發 (plus)                        |
            |   2   | 開/關 (on/off)                         |
            |   3   | 上/下/停 (forward/backward/halt)       |
            | 100,n | 調光 (0~100%), n=線性時間 (單位: 1/10秒) |
            | n1~n2 | 指定某段範圍值, 如: 温度                 |

        * ui: 對應 UI 呈現類型，待 UI 設計確認。

    * 接收回應 JSON 格式:
        ```js
        {
            "m_id": "**My-ID**",                // 註冊時送出的自定模組ID
            "status": 0,                        // 0:成功, 非零:錯誤
            "payload": "**msg**"                // 加密資料 或 錯誤訊息
        }

        // 註冊成功後解密 payload 為 JSON 字串如下:
        {
            "id": "__本地系統唯一ID__",           // 若模組ID有衝突, 則為新模組ID, 否則不變同原有送出的模組ID
            "auth-token": "__身份驗證令牌__"      // 狀態回覆時要帶上此值
        }
        ```

        1. 註冊失敗返回 payload 為錯誤訊息。
        2. 註冊成功時返回 payload 要以 AES CTR 演算法用送出的 key 去解密，參考 [AES-JS](https://github.com/ricmoo/aes-js)。
        3. 若模組 ID 與已註冊模組有衝突時，則會返回唯一模組 ID。以後通訊則必須使用這個指定的模組 ID 來通訊。
