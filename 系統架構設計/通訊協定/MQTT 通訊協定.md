# MQTT 通訊協定

![各系統訊息轉換示意圖](https://cacoo.com/diagrams/XIbHkJ4p7f6aNVdg-CB5DB.png)

## MQTT 登入

請用 [`<WebAPI>/login`](./Web%20API.md#app-登錄取得取得-mqtt-通訊時所需的資訊) 取得取得 MQTT 通訊時所需的資訊。

```js
```

## 查詢伺服器下各模組/設備組態

方向 | MQTT 主題
:---:|----
App → 伺服器 | `to/$YS/<cid>`
<sup>註: MQTT 主題 為 [`<WebAPI>/login`](./Web%20API.md#app-登錄取得取得-mqtt-通訊時所需的資訊) 時所回應的 `topic.pub` + `$YS`</sup>

1. App 請求伺服器所有模組組態:

    ```js
    {
        "cmd": 1,
        "version": _version_
    }
    ```

    * App 依專案包含的伺服器向雲端系統提出多個伺服器的模組組態請求。
    * MQTT 主題中的 `<cid>` 為客端設備登入的帳號 `__loginid__`。
    * `_version_` 為版本數值，若伺服器版本號碼大於請求方的值，則會送出該伺服器所有模組組態。現存的版本號號從 1 計起，每次組態有變更則加 1，因此請求方的 `_version_` 若為零則表示要求伺服器重送出所有模組組態。

1. App 請求逐一比對指定伺服器/模組/設備版本之後的組態:

    ```js
    {
        "cmd": 1,
        "s_id": "__伺服器ID__",
        "modules": {
            "__模組ID__": {
                "version": _version_,
                "devices": {
                    "__設備ID__": _version_,
                    // 其他設備版本
                }
            },
            // 其他模組...
        }
    }
    ```


## 伺服器回應各模組/設備組態

方向 | MQTT 主題
:---:|----
伺服器 → App | `to/<cid>`

1. 伺服器回應新版本的模組/設備及其下的功能組態:

    ```js
    {
        "cmd": 101,
        "s_id": "__伺服器ID__",
        "version": _version_,
        "name": "**伺服器名稱**",
        "modules": {                            // 模組物件
            "__模組ID__": {
                "version": _version_,
                "name": "**模組名稱**",
                "devices": {                    // 設備物件
                    "__設備ID__": {
                        "version": _version_,
                        "name": "**設備名稱**",
                        "type": "**設備型號**",
                        "icon_id": "__設備清單id__",
                        "functions": {          // 功能物件
                            "__功能ID__": {
                                "name": "**功能名稱**",
                                "type": 1,              // 輸入(讀取狀態):1, 輸出(控制):2, 輸出入:3
                                "value": "__Value__",   // 1, 2, 3, 100/n, n1~n2
                                "ui": "__UI__",         // UI 元件
                                "attention": {          // 可關注才有 (一定要有可讀取狀態, type & 1 == 1)
                                    "message": "**通知訊息**",
                                    "icon": "**icon檔**",
                                    "sound": "**音效檔**"
                                }
                            },
                            // 其他功能
                        }
                    },
                    // 其他設備
                }
            },
            // 其他模組
        }
    }
    ```

    functions 中的欄位說明:
    * type: 定義功能為可讀取(狀態)或可輸出(控制)

        |  值  |     說明         |
        |:---:|------------------|
        |   1  | 可讀取狀態       |
        |   2  | 可輸出控制       |
        |   3  | 可讀取/輸出      |
        | +16  | 情境 (輸出)       |
        | +32  | 智慧控制/排程 (輸出入) |
        | +64  | 可關注           |
        | +128 | 可製作圖表 (可讀取) |

        <sup>[註] Bit4: 可出現在情境中，Bit5: 可出現在智慧控制/排程中，Bit 6: 可關注，Bit 7: 可製作圖表</sup>

    * value: 定義功能讀取或輸出的值域

        |   值  |    說明                                  |
        |:-----:|------------------------------------------|
        |   1   | 一次觸發 (pulse)                         |
        |   2   | 開/關 (on/off)                           |
        | 100,n | 調光 (0~100%), n=線性時間 (精確度 0.1 秒) |
        | n1~n2 | 指定某段範圍值, 如: 温度                 |
        | `null` | *** 僅在回應狀態表示該功能已失聯        |

    * ui: 定義終端 UI 元件呈現功能方式，
        1. 以五碼十六進位表示，詳見【UI定義與設計規範】文件。
        2. 在通訊模組中須儘可能依 UI 設計規範來設定 `__UI__`，以便套用 UI 模版能有最佳畫面呈現。

1. 若 `__伺服器ID__`、`__模組ID__` 或 `__設備ID__` 已不存在，則返 `_version_` 為 `0`:

    ```js
    {
        "cmd": 101,
        "s_id": "__伺服器ID__",
        "version": 10,
        "name": "**伺服器名稱**",
        "modules": {
            "__模組ID__": {
                "version": 0    // 此模組不存在
            },
            // 其他模組...
        }
    }
    ```


## 模組/設備/功能狀態變更

1. 各通訊模組在設備/功能狀態有變更時，主動向本地伺服器送出最新狀態:

    方向 | MQTT 主題
    :---:|----
    通訊模組 → 本地伺服器, App | `from/<mid>`

    ```js
    {
        "cmd": 2,
        "payload": "|模組ID|設備ID|功能ID|最新狀態值" // 或陣列
    }
    ```

    * `payload` 中的第一個欄位 `伺服器ID` 可以省略，通訊模組的訊息一定是送往本地主機。若要帶上 `伺服器ID` 時一定是 `本地伺服器ID`，否則此訊息會被丟棄。
    * 若同時有多組設備/功能狀態異動時， `payload` 可用陣列表示，例如:\
    `"payload": [ "|模組ID|設備ID|功能ID|最新狀態值", ... ]`

1. 本地伺服器收到狀態變更:

    於 `payload` 欄位的 `伺服器ID` 換置成 `本地伺服器ID`，增加時戳欄位 `_timestamp_`，送往雲端系統:

    方向 | MQTT 主題
    :---:|----
    本地伺服器 → 雲端伺服器, App | `from/<sid>/<mid>`

    ```js
    {
        "cmd": 2,
        "payload": "伺服器ID|模組ID|設備ID|功能ID|最新狀態值", // 或陣列
        "timestamp": _timestamp_
    }
    ```

    * `_timestamp_` 為自 1970-01-01 (UTC) 起的毫秒數。對 App 而言，只要記住伺服器最後一次的時間戳記，在斷線重連時要求重送此時間後的更新狀態即可，見隨後 [查詢模組/設備/功能最新狀態](#查詢模組設備功能最新狀態)。


## 控制模組/設備/功能

由 App 或 `情境/智慧控制/排程` 觸發送出:

方向 | MQTT 主題
:---:|----
App → 通訊模組 | `to/<mid>`
雲端 App → 雲端伺服器 | `to/<sid>/<mid>`


```js
{
    "cmd": 3,
    "payload": "伺服器ID|模組ID|設備ID|功能ID|**欲變更狀態值**"
}
```

* 通訊模組收到時 `伺服器ID`、`模組ID` 可不理會，在本地伺服器轉送時會被清空，每個通訊模組只會收到屬於自己的訊息。


## 查詢模組/設備/功能最新狀態

1. App 啟動或斷線重連後要求各模組/設備/功能的最新狀態:

    方向 | MQTT 主題
    :---:|----
    App → 伺服器 | `to/$YS/<cid>`

    ```js
    {
        "cmd": 4,
        "payload": "伺服器ID|模組ID|設備ID|功能ID|_timestamp_"
    }
    ```

* 當本地伺服器重新連線時，雲端系統亦會向本地伺服器發出本查詢狀態請求。
* `_timestamp_` 表示查詢這個時間點後有異動的狀態，如果為零則表示所有的狀態。
* `payload` 中的 `模組ID|設備ID|功能ID` 可以由右向左省略，表示要求某一項目以下的狀態:
    * `伺服器ID|模組ID|設備ID|功能ID|_timestamp_` 查單一功能狀態。
    * `伺服器ID|模組ID|設備ID|_timestamp_` 查此設備下所有功能狀態。
    * `伺服器ID|模組ID|_timestamp_` 查此模組下所有設備/功能狀態。
    * `伺服器ID|_timestamp_` 查此伺服器下所有模組/設備/功能狀態。


## 回應指定時間點後各模組/設備/功能最新狀態

伺服器收到查詢最新狀態，或通訊模組重新連線時主動送出:

方向 | MQTT 主題
:---:|----
通訊模組 → 本地伺服器 | `to/$YS`
本地伺服器 → 雲端伺服器 | `to/$YS/<sid>`
伺服器 → App | `to/<cid>`、`to/<sid>/<cid>`

```js
{
    "cmd": 104,
    "payload": [ "伺服器ID|模組ID|設備ID|功能ID|狀態值|_timestamp_", ... ]
}
```

* `通訊模組 → 本地伺服器` 時，`伺服器ID` 為空值，且可省略 `_timestamp_` 欄位，本地伺服器在收到各設備/功能狀能值時會自動記錄此時的時間戳記。
* 如果自指定時間後都沒有異動，則返回 `payload` 為空陣列:
    ```js
    {
        "cmd": 104,
        "payload": []
    }
    ```


## 通訊模組註冊/異動/移除

1. 通訊模組第一次要先向本地伺服器註冊，送出組態結構，並取得模組身份驗證令牌。

    方向 | MQTT 主題
    :---:|----
    通訊模組 → 本地伺服器 | `to/$YS`

    ```js
    {
        "cmd": 20,                          // 通訊轉接模組 → 本地伺服器
        "m_id": "__模組ID__",
        "version": _version_,
        "name": "**自定模組名稱**",
        "devices": {                        // 設備物件
            "**自定設備ID**": {
                "version": _version_,
                "name": "**自定設備名稱**",
                "type": "**設備型號**",
                "icon_id": "__設備清單id__",
                "functions": {              // 功能物件
                    "**自定功能ID**": {
                        "name": "**自定功能名稱**",
                        "type": 1,              // 可讀取狀態:1, 可輸出控制:2, 輸出入:3
                        "value": "__Value__",   // 1, 2, 3, 100/n, n1~n2
                        "ui": "__UI__",         // UI 元件
                        "attention": {          // 可關注才有 (一定要有可讀取狀態, type & 1 == 1)
                            "message": "**通知訊息**",
                            "sound": "**音效檔**",      // 可省略
                            "icon": "**圖示檔**"        // 可省略
                        }
                    },
                    // 第 2,3,... 功能
                }
            },
            // 第 2,3,... 設備
        }
    }
    ```

    <sup>註: `devices` 結構內容請參考 [伺服器回應各模組/設備組態](#伺服器回應各模組設備組態)。<sup>

    接收本地伺服器回應 JSON 格式:

    方向 | MQTT 主題
    :---:|----
    本地伺服器 → 通訊模組 | `to/<mid>`


    ```js
    {
        "cmd": 120,                         // 系統回覆註冊結果
        "status": 0,                        // 0:成功, 非零:錯誤
        "payload": "**msg**"                // 錯誤訊息
    }
    ```

    * 註冊失敗返回 payload 為錯誤訊息。
    * 若 `**自定模組ID**` 與已註冊模組有衝突時，則會返回 `__本地模組唯一ID__`。以後通訊則必須使用這個指定的模組 ID。

1. 當通訊模組卸下不再使用時請向本地伺服器註銷解除之，或本地伺服器定時發送 Ping 訊息，若達一定時間模組沒回應視同失聯，再超過指定註銷時間則移除之。

    `通訊模組 → 本地伺服器`

    ```js
    {
        "cmd": 21,                          // 通訊轉接模組 → 本地伺服器
        "m_id": "__模組ID__"
    }
    ```

    接收本地伺服器回應 JSON 格式:

    `本地伺服器 → 通訊模組`

    ```js
    {
        "cmd": 121,                         // 本地伺服器 → 通訊轉接模組
        "m_id": "__模組ID__",              // 註冊時送出的自定模組ID
        "status": 0,                        // 0:成功, 非零:錯誤
        "payload": "**msg**"                // 當 "status" 不為零時表示錯誤訊息
    }
    ```

1. 模組組態有異動時 (增刪改設備/功能的基本設定)，請將對應設備版本號碼加一，將整個組態結構送出通知伺服器及 App。App 自行決定收到後通知用戶是否立即重設專案或延後設定。

    `本地伺服器 → 通訊模組`

    ```js
    {
        "cmd": 22,                          // 通訊轉接模組 → 本地伺服器
        // ... 以下內容同 cmd 20
        "m_id": "__模組ID__",
        "version": _version_,
        "name": "**自定模組名稱**",
        "devices": {
            // ...
        }
    }
    ```


## 本地伺服器向雲端系統註冊/移除

1. 本地伺服器連線到雲端:
    1. 用戶先向雲端註冊帳號，取得伺服器身份驗證令牌，參考 [??]()。

    1. 身份驗證令牌連結到本地伺服器後，伺服器連線雲端主機註冊。

        `本地伺服器 → 雲端伺服器`

        ```js
        {
            "cmd": 25,                          // 本地伺服器 → 雲端伺服器
            "s_id": "**自定伺服器ID**"
        }
        ```

        接收雲端伺服器回應 JSON 格式:

        `雲端伺服器 → 本地伺服器`

        ```js
        {
            "cmd": 125,                         // 本地伺服器 → 通訊轉接模組
            "s_id": "**自定伺服器ID**",          // 註冊時送出的自自定伺服器ID
            "status": 0,                        // 0:成功, 非零:錯誤
            "payload": "**msg**"                // 錯誤訊息
        }

        // 註冊成功後解密 payload 為 JSON 字串如下:
        {
            "id": "__伺服器唯一ID__",
        }
        ```

        * 註冊失敗返回 payload 為錯誤訊息。
        * 若 `**自定伺服器ID**` 與已註冊伺服器有衝突時，則會返回 `__伺服器唯一ID__`。以後通訊則必須使用這個指定的伺服器 ID。

    1. 送出本地的各模組組態結構，參考 [回應伺服器下各模組/設備組態](#回應伺服器下各模組設備組態)。

    1. 同步用戶帳號及相關專案設定，參考 [本地伺服器和雲端系統同步資訊](#本地伺服器和雲端系統同步資訊)。


1. 解除註冊: 本地伺服器不再使用雲端服務，或與雲端主機斷線達一定時間後亦會被雲端主機視用解除註冊。日後要再使用雲端服務時，請重新註冊才可使用。

    `本地伺服器 → 雲端伺服器`

    ```js
    {
        "cmd": 26,                          // 本地伺服器 → 雲端伺服器
        "s_id": "__本地伺服器ID__"
    }
    ```

    接收本地伺服器回應 JSON 格式:

    `雲端伺服器 → 本地伺服器`

    ```js
    {
        "cmd": 126,                         // 雲端伺伺服器 → 本地伺服器
        "s_id": "__本地伺服器ID__",
        "status": 0,                        // 0:成功, 非零:錯誤
        "payload": "**msg**"                // 當 "status" 不為零時表示錯誤訊息
    }
    ```



## 系統訊息

1. 心跳及回應:

    方向 | MQTT 主題
    :---:|----
    本地伺服器 → 通訊模組 | `to/<mid>/$YS`
    雲端伺服器 → 本地伺服器 | `to/<sid>/$YS`
    本地/雲端伺服器 → App | `to/<cid>/$YS`

    ```js
    // 發送端
    {
        "cmd": 30,
        "timestamp": _timestamp_    // milliseconds since 01 January, 1970 UTC
    }
    ```

    方向 | MQTT 主題
    :---:|----
    通訊模組 → 本地伺服器  | `to/$YS`
    本地伺服器 → 雲端伺服器 | `to/$YS`
    App → 本地/雲端伺服器 | `to/$YS`

    ```js
    // 接收端回應
    {
        "cmd": 130,
        "?_id": "**ID**"
    }
    ```

    * 在無通訊狀況時，伺服器每一段時間 (目前暫定一分鐘) 會向連線者送出心跳訊息。
    * 收到心跳訊息時，回應並帶上自己的 ID 回覆之:
        + 通訊轉接模組回應本地伺服器: `"m_id": "__通訊轉接模組ID__"`。
        + 本地伺服器回應雲端伺服器: `"s_id": "__本地伺服器ID__"`。
        + App (Client) 回應本地/雲端伺服器: `"c_id": "__loginid__"`。

1. 系統維護: 通知各通訊模組系統暫停作業，本地通訊模組執行關閉程序。而經由外部 MQTT 連線模組則會收到系統維護訊息後中斷連線，建議每 30 秒或一分鐘再嘗試連線，直到接通為止。

    方向 | MQTT 主題
    :---:|----
    本地伺服器 → 通訊模組 | `from/$YS`
    雲端伺服器 → 本地伺服器 | `from/$YS`
    本地/雲端伺服器 → App | `from/$YS`

    ```json
    {
        "cmd": 31,
        "payload": "**系統廣播訊息**"
    }
    ```


## 本地伺服器和雲端系統同步資訊

1. 用戶帳號狀態

    ```js
    {
        "cmd": 40,
        "s_id": "__伺服器ID__",
        "data": _base64_string_
    }
    ```

    * `data` 內容包含用戶帳號相關資訊。

1. 用戶專案的備份資訊

   App 送出備份資料:

    ```js
    {
        "cmd": 41,
        "s_id": "__伺服器ID__",
        "p_id": "__專案ID__",
        "data": _base64_string_
    }
    ```

    * 版本號碼以 `YYYYMMDD-HHMMSS` 表示。
    * 每一用戶各專案只保留最近 10 個版本。
    * `data` 內容由各 App 自定，本系統不管其內容，僅將之儲存供還原用。
    * 伺服器收到後加上欄位 `"version": "YYYYMMDD-HHMMSS"`，再同步到本地或雲端伺服器。

1. 用戶專案的還原資訊

    1. App 送出查詢專案目前有那些備份版本:

        ```js
        {
            "cmd": 42,
            "s_id": "__伺服器ID__",
            "p_id": "__專案ID__"
        }
        ```

        伺服器回應:

        ```js
        {
            "cmd": 142,
            "s_id": "__伺服器ID__",
            "p_id": "__專案ID__",
            "list": [ _version_, ... ]
        }
        ```

        返回版本清單由近到遠。

    1. App 送出還原專案備份版本:

        ```js
        {
            "cmd": 43,
            "s_id": "__伺服器ID__",
            "p_id": "__專案ID__"，
            "version": _version_            // 省略表示要求最後一次的版本
        }
        ```

        `version` 省略時表示要求最後一次的版本。

        伺服器回應:

        ```js
        {
            "cmd": 143,
            "s_id": "__伺服器ID__",
            "p_id": "__專案ID__",
            "version": _version_,
            "data": _base64_string_
        }
        ```

        若指定版本不存在時返回 `data` 為空字串。

