## 雲端伺服器 ↔ Apps

1. Apps 可連雲端伺服器或本地伺服器 --> 如何自動判斷連接本地伺服器?

1. login: UserName + Password 取得 Token。

1. 取得組態 --> 產生專案，一次只監控一個專案，但專案可能跨多個 Local Server。

1. 伺服器回應狀態給 Apps: (當狀態改變)
    * REST API: `POST` `http://server:port/api`

    * MQTT: `mqtt://server:port/reply/**客戶端ID**`

    * 回應狀態:
        ```js
        {
            "cmd": 21,                  // 本地伺服器 → { 雲端伺服器 → } Apps
            "s_id": "**伺服器ID**",
            "modules": {
                "**模組ID**": {
                    "**設備ID**": {
                        "**功能ID**": "**最新狀態值**",
                        // 其餘功能的最新狀態值...
                    },
                    // 其餘設備的各功能狀態值...
                },
                // 其餘模組...
            }
        }
        ```

1. Apps 送出控制命令給伺服器:
    * MQTT: `mqtt://server:port/public`

    * 控制設備/功能為指定值:
        ```js
        {
            "cmd": 22,                  // Apps → { 雲端伺服器 → } 本地伺服器
            "**伺服器ID**": {
                "**模組ID**": {
                    "**設備ID**": {
                        "**功能ID1**": "**欲變更狀態值**",
                        "**功能ID2**": "**欲變更狀態值**",
                        // 其他功能...
                    },
                    // 其他設備...
                },
                // 其他模組...
            },
            "c_id": "**ClientID**",
            "token": "__身份驗證令牌__"
        }
        ```

    * 查詢設備/功能狀態:
        ```js
        {
            "cmd": 23,                  // Apps → { 雲端伺服器 → } 本地伺服器
            "**伺服器ID**": {
                "**模組ID**": {
                    "**設備ID**": [
                        // 查詢那些功能狀態
                        "**功能ID1**",
                        "**功能ID2**",
                        //...
                    ],
                    // 其他設備...
                },
                // 其他模組...
            },
            "c_id": "**ClientID**",
            "token": "__身份驗證令牌__"
        }
        ```

        * 若 `**伺服器ID**` 的值為空物件或空陣列，則表示要查全部的模組、設備及功能狀態值。
            ```js
            {
                "cmd": 23,                  // Apps → { 雲端伺服器 → } 本地伺服器
                "**伺服器ID**": {},
                "c_id": "**ClientID**",
                "token": "__身份驗證令牌__"
            }
            ```

        * 若 `**伺服器ID**` 的值為陣列，則表示要查陣列中指定模組的全部功能狀態值。
            ```js
            {
                "cmd": 23,                  // Apps → { 雲端伺服器 → } 本地伺服器
                "**伺服器ID**": ["**模組1**", "**模組2**", ...],
                "c_id": "**ClientID**",
                "token": "__身份驗證令牌__"
            }
            ```

    * 執行情境: (是否需要一次執行多個情境?)
        ```js
        {
            "cmd": 24,                  // Apps → { 雲端伺服器 → } 本地伺服器
            "**伺服器ID**": "**情境ID**",
            "c_id": "**ClientID**",
            "token": "__身份驗證令牌__"
        }
        ```

1. 智慧控制 (連動)、排程: 一律在 Local Server 觸發執行，和雲端伺服器、Apps 無關。
