<h1>系統攝影機模組</h1>

* 系統攝影機模組 ID = "`$01`"。
* 本模組初始化經由 onvif 通訊協定，尋找本地 (LAN) 支援的攝影機。
* 每一攝影機為模組下的一個設備，其下可能會有多個影像串流 (多個攝像頭或不同解析度)。本模組以 `functions` 物件來表示不同的串流，因此在組態結構中會比其他模組多一些欄位。

以下將針對本模組和 【[MQTT 通訊協定](./MQTT%20通訊協定.md)】 一般模組不同之處說明:

[[TOC]]


## 服務器回應系統攝影機模組/設備組態 (cmd=101)

方向 | MQTT 主題
:---:|----
服務器 → App | `to/<cid>/$YS`

1. 服務器回應新版本的模組/設備及其下的串流 (功能) 組態:

    ```json
    {
      "cmd": 101,
      "status": 0,
      "payload": {
        // ...服務器基本資訊...
        "modules": {
          "$01": {    // 系統攝影機模組
            "name": "攝影機",
            "version": _version_,
            "devices": {
              "D01": {
                "name": "海康 DVR",
                "type": "DS-7204HQHI-K1",
                "version": _version_,
                "icon_id": "085",
                "functions": {
                  "V01": {
                    "name": "工程 960×480",
                    "rtsp": "rtsp://{IP}:1980/Streaming/channels/101",
                    "resolution": [960, 480],
                    "ptz": "",
                    "type": 1
                  },
                  "V02": {
                    "name": "研發 960×480",
                    "rtsp": "rtsp://{IP}:1980/Streaming/channels/201",
                    "resolution": [960, 480],
                    "ptz": "",
                    "type": 1
                  }
                }
              },
              "D02": {
                "name": "Vstarcam",
                "type": "Hi3518eV100",
                "version": _version_,
                "icon_id": "085",
                "functions": {
                  "V01": {
                    "name": "研發 1280×720",
                    "rtsp": "rtsp://{IP}:12554/tcp/av0_0",
                    "resolution": [1280, 720],
                    "ptz": "xyz",
                    "type": 3
                  },
                  "V02": {
                    "name": "研發 640×360",
                    "rtsp": "rtsp://{IP}:12554/tcp/av0_1",
                    "resolution": [640, 360],
                    "ptz": "xyz",
                    "type": 3
                  }
                }
              }
            }
          }
          // 其他模組
        }
      }
    }
    ```

    `functions` 表示該攝影機設備有多少串流，每一串流欄位說明如下:
    * `rtsp`: 接收影像串流的位址 (uri)，格式為: `rtsp://{IP}/路徑`。在視訊連線時 `{IP}` 必須以實際 ip 取代，參見後面 [查詢系統視訊模組各設備連線 IP](#查詢系統視訊模組各設備連線-ip-cmd32)。
    * `resolution`: 為一影像解析度陣列，內容為像素寬×高 (pixel)。
    * `ptz`: 是否支援 左右(Pan, x 軸) / 上下(Tile, y 軸) 旋轉 或 縮放(Zoom)，分別以字元 'x','y','z' 表示之。
    * `type`: 該攝影機支援 `ptz` 時為 3，表示可控制。否則為 1 表示僅能讀取，不可控制。


## 系統攝影機串流預設點狀態回報 (cmd=2)

方向 | MQTT 主題
:---:|----
通訊模組 → 本地服務器, App | `from/$01`

```json
{
    "cmd": 2,
    "payload": "服務器ID|$01|設備ID|串流ID|預設點狀態"
}
```

* `預設點狀態` 為整數值，以位元 0~15 分別表示預設點 1~16 是否已設定 (`0`: 未設定，`1`: 已設定)。App 可在設定攝影機預設點時呈現該點是否已設定，或在控制畫面對未設定的點呈現不可控制狀態。
* 當有人設定了新的預設點 (之前未設定過)，這時就會回報更新的預設點狀態。


## 控制系統攝影機串流 (cmd=3)

由 App 觸發送往系統攝影機模組:

方向 | MQTT 主題
:---:|----
App → 通訊模組 | `to/$01/<cid>`

```json
{
    "cmd": 3,
    "payload": "服務器ID|$01|設備ID|串流ID|**控制命令**"
}
```

* 僅當 `串流ID` 支援 `ptz` 功能時控制方有效。
* `**控制命令**` 格式為 `命令: 參數`，說明如下:
    命令 | 參數 | 說明
    :---:|:---:|---
    Move | 0~9 | 鏡頭移動方向，`0`:停止，`1~9` (鍵盤數字九宮鍵方向，`5` 視同 `0` 停止)
    Zoom | In,Out,Stop | 鏡頭拉近 (zoom-`In`)、拉遠 (zoom-`Out`) 或停止 (`Stop`, 或 `0`)
    Goto | 1~16 | 鏡頭直接移到預設點 `1~16`
    Preset | 1~16 | 設定目前鏡頭位置為預設點 `1~16`

    + 命令或參數為字母時可以只用字首表示 (不分大小寫)。
    + 當命令 `Move` 或 `Zoom` 的 `參數` 為 `0` 或 `Stop`，會同時停止鏡頭的移動及縮放。
    + `Move` 命令的標的參數亦可用 `L`(Left)、`R`(Right)、`U`(Up)、`D`(Down) 字母組合:

        ↖ | ↑ | ↗ | | 7 | 8 | 9 | | LU | U | RU
        --|---|---|-|---|---|---|-|:--:|---|:-:
        ← | ■ | → | | 4 | 5 | 6 | | L  | S | R
        ↙ | ↓ | ↘ | | 1 | 2 | 3 | | LD | D | RD


範例: 控制鏡頭往左上
```json
{
    "cmd": 3,
    "payload": "|$01|D02|V01|M:7"   // 或 "M:LU"
}
```

範例: 停止鏡頭移動
```json
{
    "cmd": 3,
    "payload": "|$01|D02|V01|M:0"
}
```


## 查詢系統視訊模組各設備連線 IP (cmd=32)

方向 | MQTT 主題
:---:|----
App → 服務器 | `to/$YS/<cid>`

```json
// App 發送
{
    "cmd": 32
}
```

### 回覆查詢系統視訊模組各設備連線 IP (cmd=132)

方向 | MQTT 主題
:---:|----
服務器 → App | `to/<cid>/$YS`

```js
// 服務器回應
{
    "cmd": 132,
    "status": 0,
    "public_ip": "_ip_address_"，
    "payload": {
        "D01": "_ip_address_",
        "D02": "_ip_address_"
    }
}
```

* 請在每次 MQTT 連線時以此命令查詢更新各視訊串流連線位址。
* 系統會根據 `<cid>` 目前連線位址，送出系統視訊模組 (`$01`) rtsp 串流連線 ip (內網或外網)。
* `payload` 內容為系統視訊模組 (`$01`) 視訊設備 ID 之下的各串流對應連線的 ip。App 應將此 `_ip_address_` 取代視訊模組 ID 各串流 (`functions`) 中 `rtsp` 欄位的 `{IP}` 字串。

以前面的組態為範例

1. 在內網連線:
    ```json
    // 收到服務器回應
    {
        "cmd": 132,
        "status": 0,
        "public_ip": "1.2.3.4",
        "payload": {
            "D01": "192.168.1.33",
            "D02": "192.168.1.32"
        }
    }
    ```

    App 應更新串流 uri 如下:

    設備ID | 串流ID | rtsp uri
    :---:|:---:|---
    D01 | V01 | rtsp://192.168.1.33:1980/Streaming/channels/101
    D01 | V02 | rtsp://192.168.1.33:1980/Streaming/channels/201
    D02 | V01 | rtsp://192.168.1.32:12554/tcp/av0_0
    D02 | V02 | rtsp://192.168.1.32:12554/tcp/av0_1

1. 在外網連線:
    ```json
    // 收到服務器回應
    {
        "cmd": 132,
        "status": 0,
        "public_ip": "1.2.3.4",
        "payload": {
            "D01": "1.2.3.4",
            "D02": "1.2.3.4"
        }
    }
    ```

    App 應更新串流 uri 如下:

    設備ID | 串流ID | rtsp uri
    :---:|:---:|---
    D01 | V01 | rtsp://1.2.3.4:1980/Streaming/channels/101
    D01 | V02 | rtsp://1.2.3.4:1980/Streaming/channels/201
    D02 | V01 | rtsp://1.2.3.4:12554/tcp/av0_0
    D02 | V02 | rtsp://1.2.3.4:12554/tcp/av0_1
