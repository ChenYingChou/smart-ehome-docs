## 通訊轉接模組 ↔ 本地伺服器

1. 標準 json 格式: `Cmd, {Server,} {Module,} Device, Function, Value, {Token}` <br> 範例: 設定會議室空調温度為 26 度。
    ```js
    {
        "cmd": 2,                       // 本地伺服器 → 通訊轉接模組
        "AM210-1": {                    // 模組ID
            "Conditioner": {            // 設備ID: 會議室空調
                "Temperature": 26       // 功能ID: 温度 = 26°C
            }
        }
    }
    ```

2. 通訊轉接模組第一次向 Server 註冊:
    * REST API: `POST http://local-server:port/api`

    * MQTT: `mqtt://local-server:port`
        * 送出 `topic = "public"`
        * 接收 `topic = "reply"`

    * 送出本模組所擁有的 "設備/功能/類型/值域/UI 元件":
        ```js
        {
            "cmd": 99,                          // 通訊轉接模組 → 本地伺服器
            "m_id": "**自定模組ID**",
            "name": "**自定模組名稱**",
            "devices": {                        // 設備物件
                "**自定設備ID**": {
                    "name": "**自定設備名稱**",
                    "functions": {              // 功能物件
                        "**自定功能ID**": {
                            "name": "**自定功能名稱**",
                            "type": 1,              // 可讀取狀態:1, 可輸出控制:2, 輸出入:3
                            "value": "__Value__",   // 1, 2, 3, 100/n, n1~n2
                            "ui": "__UI__",         // UI 元件
                            "attention": {          // 可關注才有 (一定要有可讀取狀態, type & 1 == 1)
                                "message": "**通知訊息**",
                                "sound": "**音效檔**",      // 可省略
                                "icon": "**圖示檔**"        // 可省略
                            }
                        },
                        // 第 2,3,... 功能
                    }
                },
                // 第 2,3,... 設備
            },
            "key": "**16 個隨機字元轉十六進位字串, 共 32 HEX 字元**"
        }
        ```

        functions 中的欄位說明:
        * type: 定義功能為可讀取(狀態)或可輸出(控制)

            |  值  |     說明         |
            |:----:|------------------|
            |   1  | 可讀取狀態       |
            |   2  | 可輸出控制       |
            |   3  | 可讀取/輸出      |
            | +16  | 情境 (輸出)       |
            | +32  | 智慧控制/排程 (輸出入) |
            | +64  | 可關注           |
            | +128 | 可製作圖表 (可讀取) |

            <sup>[註] Bit4: 可出現在情境中，Bit5: 可出現在智慧控制/排程中，Bit 6: 可關注，Bit 7: 可製作圖表</sup>

        * value: 定義功能讀取或輸出的值域

            |   值  |    說明                                  |
            |:-----:|------------------------------------------|
            |   1   | 一次觸發 (puls)                          |
            |   2   | 開/關 (on/off)                           |
            | 100,n | 調光 (0~100%), n=線性時間 (精確度 0.1 秒) |
            | n1~n2 | 指定某段範圍值, 如: 温度                 |

        * ui: 定義終端 UI 元件呈現功能方式，
            1. 以五碼十六進位表示，詳見【UI定義與設計規範】文件。
            2. 在通訊模組中須儘可能依 UI 設計規範來設定 `__UI__`，以便套用 UI 模版能有最佳畫面呈現。
            <br>

    * 接收回應 JSON 格式:
        ```js
        {
            "cmd": 99,                          // 本地伺服器 → 通訊轉接模組
            "m_id": "**My-ID**",                // 註冊時送出的自定模組ID
            "status": 0,                        // 0:成功, 非零:錯誤
            "payload": "**msg**"                // 加密資料 或 錯誤訊息
        }

        // 註冊成功後解密 payload 為 JSON 字串如下:
        {
            "id": "__本地系統唯一ID__",         // 若模組ID有衝突, 則為新模組ID, 否則不變同原有送出的模組ID
            "token": "__身份驗證令牌__"         // 送往 Server 要帶上此值
        }
        ```

        * 註冊失敗返回 payload 為錯誤訊息。
        * 註冊成功時返回 payload 要以 AES CTR 演算法用送出的 key 去解密，參考 [AES-JS](https://github.com/ricmoo/aes-js)。
        * 若模組 ID 與已註冊模組有衝突時，則會返回 `__本地系統唯一ID__`。以後通訊則必須使用這個指定的模組 ID。
        <br>

3. 通訊轉接模組向 Server 解除註冊:
    * REST API: `POST http://local-server:port/api`

    * MQTT: `mqtt://local-server:port`
        * 送出 `topic = "public"`
        * 接收 `topic = "reply"`

    * 送出本模組解除註冊要求:
        ```js
        {
            "cmd": 98,                  // 通訊轉接模組 → 本地伺服器
            "m_id": "**模組ID**",
            "token": "__身份驗證令牌__"
        }
        ```

    * 接收回應 JSON 格式:
        ```js
        {
            "cmd": 98,                  // 本地伺服器 → 通訊轉接模組
            "m_id": "**模組ID**",
            "status": 0,                // 0:成功, 非零:錯誤
            "payload": "**msg**"
        }
        ```

        * 解除註冊失敗返回 payload 為錯誤訊息。
        * 即使不解除註冊，但只要通訊轉接模組離線超過一定期限，Server 也會自動解除註冊。亦可透過管理系統來解除註冊。
        * 解除註冊後要再重新註冊才可連線。
        <br>

4. 通訊轉接模組回應狀態給 Server: (當狀態改變或收到 Server 要求回報現在狀態)
    * REST API: `POST http://local-server:port/api`

    * MQTT: `mqtt://local-server:port/public`

    * 回應狀態:
        ```js
        {
            "cmd": 1,                   // 通訊轉接模組 → 本地伺服器
            "m_id": "**模組ID**";
            "devices": {
                "**設備ID**": {
                    "**功能ID**": "**最新狀態值**",
                    // 其餘功能的最新狀態值...
                },
                // 其餘設備的各功能狀態值...
            },
            "token": "__身份驗證令牌__"
        }
        ```

5. 通訊轉接模組接收 Server 命令:
    * MQTT: `mqtt://local-server:port/**模組ID**` <br> 因為是透過專用 Queue 通道，`**模組ID**` 一定是當初註冊給定的 `本地系統唯一ID`，故不需 `token` 不用驗證合法性。

    * 控制設備/功能為指定值:
        ```js
        {
            "cmd": 2,               // 本地伺服器 → 通訊轉接模組
            "**模組ID**": {
                "**設備ID**": {
                    "**功能ID1**": "**欲變更狀態值**",
                    "**功能ID2**": "**欲變更狀態值**",
                    // 其他功能...
                },
                // 其他設備...
            }
        }
        ```

    * 查詢設備/功能狀態:
        ```js
        {
            "cmd": 3,               // 本地伺服器 → 通訊轉接模組
            "**模組ID**": {
                "**設備ID**": [
                    // 查詢那些功能狀態
                    "**功能ID1**",
                    "**功能ID2**",
                    //...
                ],
                // 其他設備...
            }
        }
        ```

        * 若 `**模組ID**` 的值為空物件或空陣列，則表示要查全部的設備及功能狀態值。
            ```js
            {
                "cmd": 3,               // 本地伺服器 → 通訊轉接模組
                "**模組ID**": {}
            }
            ```

        * 若 `**模組ID**` 的值為陣列，則表示要查陣列中指定設備的全部功能狀態值。
            ```js
            {
                "cmd": 3,               // 本地伺服器 → 通訊轉接模組
                "**模組ID**": ["**設備1**", "**設備2**", ...]
            }
            ```

        * 若 `**設備ID**` 的值為空陣列，則表示要查全部的功能狀態值。
            ```js
            {
                "cmd": 3,               // 本地伺服器 → 通訊轉接模組
                "**模組ID**": {
                    "**設備ID**": [
                        // 指定功能狀態值
                        "**功能ID1**",
                        "**功能ID2**"
                    ],
                    "**設備ID**": [
                        // 空陣列表示該設備的全部功能狀態值
                    ],
                    // 其他設備...
                }
            }
            ```

6. 心跳及回應: 通訊轉接模組 ← 本地伺服器 ← 雲端伺服器 → Apps
    ```js
    // 發送端
    {
        "cmd": 0
    }

    // 接收端回應
    {
        "cmd": 0,
        "?_id": "**ID**"
    }
    ```

    * 在無通訊狀況時，伺服器每一段時間 (目前暫定一分鐘) 會向連線者送出心跳訊息。
    * 收到心跳訊息時，回應並帶上自己的 ID 回覆之:
        + 通訊轉接模組回應本地伺服器: `"m_id": "__通訊轉接模組ID__"`。
        + 本地伺服器回應雲端伺服器: `"s_id": "__本地伺服器ID__"`。
        + Apps 回應雲端伺服器: `"c_id": "__客戶端ID__"`。
